<!-- Chat component -->
<div class="bg-blue-50 rounded-lg p-4 h-full">
  <h2 class="text-xl font-semibold text-blue-700 mb-3">Chat Assistant</h2>

  <!-- Chat messages container -->
  <div
    id="chat-messages"
    class="bg-white rounded-lg border border-gray-200 p-3 h-96 mb-4 overflow-y-auto flex flex-col space-y-3"
  >
    <!-- Initial welcome message -->
    <div class="bg-gray-100 rounded-lg p-3 max-w-[80%] self-start">
      <p class="text-sm">I've reviewed the paper. What would you like to know about it?</p>
    </div>
  </div>

  <!-- Chat input -->
  <form id="chat-form" class="flex">
    <input
      type="text"
      id="chat-input"
      name="message"
      placeholder="Ask about this paper..."
      class="flex-grow rounded-l-lg border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
      required
    />
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded-r-lg px-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"
        />
      </svg>
    </button>
  </form>
</div>

<!-- Chat JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const paperId = '{{ paper.id }}';

    console.log('Chat component initialized');
    console.log('Paper ID:', paperId);

    // Function to add a message to the chat
    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser
        ? 'bg-blue-100 rounded-lg p-3 max-w-[80%] self-end'
        : 'bg-gray-100 rounded-lg p-3 max-w-[80%] self-start';

      const messagePara = document.createElement('p');
      messagePara.className = 'text-sm';
      messagePara.textContent = text;

      messageDiv.appendChild(messagePara);
      chatMessages.appendChild(messageDiv);

      // Scroll to bottom of chat
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to handle streaming response
    async function handleStreamingResponse(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let responseText = '';

      // Create a placeholder for the assistant's response
      const messageDiv = document.createElement('div');
      messageDiv.className = 'bg-gray-100 rounded-lg p-3 max-w-[80%] self-start';

      const messagePara = document.createElement('p');
      messagePara.className = 'text-sm';
      messageDiv.appendChild(messagePara);
      chatMessages.appendChild(messageDiv);

      try {
        while (true) {
          const { done, value } = await reader.read();

          if (done) {
            break;
          }

          // Decode the chunk and add it to the response text
          const chunk = decoder.decode(value, { stream: true });
          responseText += chunk;

          // Update the message with the current text
          messagePara.textContent = responseText;

          // Scroll to bottom of chat
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      } catch (error) {
        console.error('Error reading stream:', error);
        messagePara.textContent = 'Error: Could not load response.';
      }
    }

    // Handle form submission
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      // Add user message to chat
      addMessage(userMessage, true);

      // Clear input
      chatInput.value = '';

      try {
        const url = `/chat/${paperId}`;
        console.log('Fetching from URL:', url);

        // Send message to server
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage }),
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        // Handle streaming response
        await handleStreamingResponse(response);
      } catch (error) {
        console.error('Error:', error);
        console.error('Error details:', error.message);
        addMessage('Sorry, there was an error processing your request.', false);
      }
    });
  });
</script>
